<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediflow - Meeting Management</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) for Excel export functionality -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .dark ::-webkit-scrollbar-track { background: #1a2b42; }
        .dark ::-webkit-scrollbar-thumb { background: #32629d; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #4a78b0; }
        
        /* Style to hide elements */
        .hidden { display: none; }
        
        /* Style for auto-resizing textareas */
        textarea {
            resize: none;
            overflow: hidden;
            min-height: 50px;
        }

        /* Page load animation */
        .fade-in {
            animation: fadeInAnimation 0.5s ease-in-out;
        }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom theme colors for Tailwind */
        .bg-theme-primary { background-color: #154887; }
        .hover\:bg-theme-primary-dark:hover { background-color: #0f3a75; }
        .bg-theme-accent { background-color: #b39058; }
        .hover\:bg-theme-accent-dark:hover { background-color: #9e7d4c; }
        .bg-theme-danger { background-color: #ee2228; }
        .hover\:bg-theme-danger-dark:hover { background-color: #d31e24; }
        .bg-theme-card { background-color: #fefdfc; }
        .dark .dark\:bg-theme-card-dark { background-color: #1a2b42; }
        .bg-theme-background { background-color: #eaf1ed; }
        .dark .dark\:bg-theme-background-dark { background-color: #0f2138; }
        .border-theme-accent { border-color: #b39058; }
        .text-theme-primary { color: #154887; }
        .dark .dark\:text-theme-primary-light { color: #a5c3e6; }
        .text-theme-accent { color: #b39058; }
        .dark .dark\:text-theme-accent-light { color: #d4b581; }
    </style>
    <script>
        // Immediately apply theme to prevent flash of unstyled content
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-theme-background dark:bg-theme-background-dark font-sans antialiased transition-colors duration-300">

    <!-- Main application container -->
    <div id="app-root">
        <!-- Content is rendered here by JavaScript based on auth state -->
    </div>
    
    <!-- Container for modals -->
    <div id="modal-container"></div>


    <!-- JavaScript module for the application logic -->
    <script type="module">
        // Import necessary functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, getDoc, updateDoc, 
            deleteDoc, onSnapshot, query, where, serverTimestamp, writeBatch, getDocs,
            or, and
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE AND CONFIG ---

        const AppState = {
            db: null,
            auth: null,
            userId: null,
            appId: 'default-app-id',
            loading: true,
            error: null,
            currentPage: 'dashboard',
            currentMeetingId: null,
            currentSearchTerm: '',
            clinics: ['Mataram', 'Maluk', 'Bali', 'Surabaya', 'Yogyakarta', 'Semarang'],
            listeners: [], 
            chartInstances: {},
            getSharedDataPath: () => `artifacts/${AppState.appId}/public/sharedData`
        };
        
        // DOM elements
        const appRoot = document.getElementById('app-root');
        const modalContainer = document.getElementById('modal-container');

        // --- HELPER FUNCTIONS ---

        const formatDisplayDate = (dateString, options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) => {
            if (!dateString) return 'Tidak tersedia';
            const dateObj = new Date(dateString);
            if (isNaN(dateObj.getTime())) return 'Tanggal tidak valid';
            return dateObj.toLocaleDateString('id-ID', options);
        };

        const formatShortDisplayDate = (dateString) => {
            if (!dateString) return '';
            const dateObj = new Date(dateString);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        };

        const getStatusClasses = (status) => {
            switch (status) {
                case 'Done': return 'bg-green-100 text-green-800 border-green-300 dark:bg-green-900 dark:text-green-200 dark:border-green-700';
                case 'In Progress': return 'bg-yellow-100 text-yellow-800 border-yellow-300 dark:bg-yellow-900 dark:text-yellow-200 dark:border-yellow-700';
                default: return 'bg-gray-200 text-gray-800 border-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600';
            }
        };
        
        function autoResizeTextarea(element) {
            element.style.height = 'auto'; // Reset height to recalculate correctly
            element.style.height = (element.scrollHeight) + 'px'; // Set to new scroll height
        }

        function cleanupListeners() {
            AppState.listeners.forEach(unsubscribe => unsubscribe());
            AppState.listeners = [];
            Object.values(AppState.chartInstances).forEach(chart => chart.destroy());
            AppState.chartInstances = {};
        }

        const getChartThemeOptions = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#eaf1ed' : '#154887';
            const gridColor = isDarkMode ? 'rgba(234, 241, 237, 0.1)' : 'rgba(21, 72, 135, 0.1)';

            return {
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            };
        };
        
        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
            
            // Update charts with new theme colors
            const themeOptions = getChartThemeOptions();
            Object.values(AppState.chartInstances).forEach(chart => {
                chart.options.plugins.legend.labels.color = themeOptions.plugins.legend.labels.color;
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks.color = themeOptions.scales.x.ticks.color;
                    chart.options.scales.x.grid.color = themeOptions.scales.x.grid.color;
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = themeOptions.scales.y.ticks.color;
                    chart.options.scales.y.grid.color = themeOptions.scales.y.grid.color;
                }
                chart.update();
            });
        }

        // --- UI COMPONENT FUNCTIONS (TEMPLATE GENERATORS) ---
        
        const LoadingSpinner = () => `
            <div class="flex items-center justify-center min-h-screen bg-theme-background dark:bg-theme-background-dark">
                <div class="w-16 h-16 border-4 border-t-4 border-theme-primary border-solid rounded-full animate-spin"></div>
                <p class="ml-4 text-theme-primary dark:text-theme-primary-light">Memuat aplikasi...</p>
            </div>`;

        const ErrorDisplay = (message) => `
            <div class="flex items-center justify-center min-h-screen text-xl text-theme-danger"><p>${message}</p></div>`;
        
        const LoginPage = (errorMessage = '') => `
            <div class="flex flex-col items-center justify-center min-h-screen bg-theme-background dark:bg-theme-background-dark">
                <div class="p-8 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-2xl text-center w-full max-w-md transition-all duration-300">
                    <h1 class="text-5xl font-bold text-theme-primary dark:text-theme-accent-light mb-4">Mediflow</h1>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Silakan login untuk melanjutkan</p>
                    ${errorMessage ? `<p id="auth-error" class="bg-red-100 text-red-700 p-3 rounded-md mb-6">${errorMessage}</p>` : ''}
                    <button data-action="login-google" class="w-full px-6 py-3 text-white bg-theme-primary rounded-lg hover:bg-theme-primary-dark flex items-center justify-center text-lg transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-xl">
                        <svg class="w-6 h-6 mr-3" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 62.3l-66.5 64.6C305.5 102.2 279.5 96 248 96c-88.8 0-160.1 71.1-160.1 160s71.3 160 160.1 160c97.4 0 134-60.1 140.8-92.2H248v-70.1h239.9c2.5 12.7 3.9 26.1 3.9 40z"></path></svg>
                        Login with Google
                    </button>
                </div>
            </div>
        `;

        const Header = () => {
            const user = AppState.auth.currentUser;
            let authDisplay = '';
            if (user) {
                authDisplay = `
                    <span class="font-medium truncate max-w-[150px] hidden sm:inline">${user.displayName || 'User'}</span>
                    <button data-action="logout" class="px-3 py-1 text-sm text-white bg-theme-danger rounded-md hover:bg-theme-danger-dark transition-transform duration-200 hover:scale-105">Logout</button>
                `;
            }

            return `
            <header class="flex items-center justify-between p-4 bg-theme-primary shadow-lg">
                <h1 data-action="navigate" data-page="dashboard" class="text-3xl font-bold text-white cursor-pointer">Mediflow</h1>
                
                <div class="flex-1 max-w-xl mx-4">
                     <form id="global-search-form">
                        <input type="search" id="global-search-input" class="w-full px-4 py-2 text-gray-800 bg-[#fefdfc] border-2 border-transparent rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-theme-accent transition-all duration-300" placeholder="Cari di semua meeting & item tindakan...">
                     </form>
                </div>

                <nav class="hidden lg:flex items-center space-x-1">
                    <button data-action="navigate" data-page="dashboard" class="px-4 py-2 text-white/90 transition-all duration-300 rounded-md hover:bg-white/20 hover:text-white">Dashboard</button>
                    <button data-action="navigate" data-page="meetings" class="px-4 py-2 text-white/90 transition-all duration-300 rounded-md hover:bg-white/20 hover:text-white">Daftar Meeting</button>
                    <button data-action="navigate" data-page="clinic-dashboard" class="px-4 py-2 text-white/90 transition-all duration-300 rounded-md hover:bg-white/20 hover:text-white">Dashboard Klinik</button>
                    <button data-action="navigate" data-page="new-meeting" class="px-4 py-2 text-white transition-all duration-300 bg-theme-accent rounded-md hover:bg-theme-accent-dark transform hover:scale-105 shadow-md">+ Meeting Baru</button>
                    <button data-action="export-excel" class="px-4 py-2 text-white transition-all duration-300 bg-green-500 rounded-md hover:bg-green-600 transform hover:scale-105 shadow-md">Export Excel</button>
                </nav>

                <div class="flex items-center space-x-3 text-sm text-white">
                    <button data-action="toggle-theme" class="p-2 rounded-full transition-colors duration-300 hover:bg-white/20">
                        <svg id="theme-icon-light" class="w-5 h-5 ${localStorage.theme === 'dark' ? 'hidden' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-dark" class="w-5 h-5 ${localStorage.theme === 'dark' ? '' : 'hidden'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    ${authDisplay}
                </div>
            </header>`;
        }

        const MeetingCard = (meeting) => `
            <div class="p-4 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 transform">
                <h5 class="mb-2 text-xl font-semibold text-theme-primary dark:text-theme-accent-light">${meeting.title}</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    <span class="font-medium">Tanggal:</span> 
                    ${formatDisplayDate(meeting.date, { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
                <button data-action="navigate" data-page="meeting-detail" data-id="${meeting.id}" class="px-4 py-2 mt-4 text-sm text-white bg-theme-primary rounded-lg hover:bg-theme-primary-dark transition-all duration-300 transform hover:scale-105">
                    Lihat Detail Meeting
                </button>
            </div>`;

        const ActionItemListItem = (item, showControls = false, isLocal = false) => `
            <li class="p-3 bg-theme-background dark:bg-gray-800 rounded-lg shadow-md transition-shadow duration-300 hover:shadow-lg">
                <p class="font-medium text-gray-900 dark:text-[#eaf1ed]">${item.title}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">Ditugaskan ke: ${item.assignedTo}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">Batas Waktu: ${formatShortDisplayDate(item.dueDate) || 'Tidak ada'}</p>
                ${item.followUps && item.followUps.length > 0 ? `
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        <span class="font-semibold">Follow-up:</span>
                        <ul class="ml-4 list-disc list-inside">
                            ${item.followUps.map(fu => `
                                <li>
                                    ${formatShortDisplayDate(fu.followUpDate)}:
                                    ${fu.followUpDetail.split('\n').map(line => line.trim() ? `<p class="pl-4 text-sm text-gray-700 dark:text-gray-300">${line.trim().replace(/^- /, '')}</p>` : '').join('')}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
                <div class="flex items-center justify-between mt-3">
                    <div class="px-3 py-1 text-xs font-medium rounded-full ${getStatusClasses(item.status)}">${item.status}</div>
                    ${showControls ? `
                        <div class="space-x-2">
                            <button data-action="${isLocal ? 'edit-local-action-item' : 'edit-action-item'}" data-id="${item.id}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-transform duration-200 hover:scale-110" title="Edit Item Tindakan">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" /></svg>
                            </button>
                            <button data-action="${isLocal ? 'delete-local-action-item' : 'delete-action-item'}" data-id="${item.id}" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-transform duration-200 hover:scale-110" title="Hapus Item Tindakan">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
            </li>`;

        // --- PAGE RENDERING FUNCTIONS ---
        
        async function renderDashboard() {
            appRoot.querySelector('main').innerHTML = `<div class="p-6 fade-in"><h2 class="mb-6 text-4xl font-extrabold text-theme-primary dark:text-theme-accent-light">Dashboard</h2><div id="dashboard-content">${LoadingSpinner()}</div></div>`;
            const content = document.getElementById('dashboard-content');
            
            if (!AppState.db) return;

            const meetingsSnapshot = await getDocs(query(collection(AppState.db, `${AppState.getSharedDataPath()}/meetings`)));
            const actionItemsSnapshot = await getDocs(query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`)));
            
            const meetings = meetingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const actionItems = actionItemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const overdueActionItems = actionItems.filter(item => item.status !== 'Done' && item.dueDate && new Date(item.dueDate) < new Date());
            const pendingActionItems = actionItems.filter(item => item.status === 'Open' || item.status === 'In Progress');
            
            const statusCounts = actionItems.reduce((acc, item) => { acc[item.status] = (acc[item.status] || 0) + 1; return acc; }, {});
            const itemsPerClinic = actionItems.reduce((acc, item) => { const clinic = item.assignedTo || 'Unassigned'; acc[clinic] = (acc[clinic] || 0) + 1; return acc; }, {});

            content.innerHTML = `
                <div class="grid grid-cols-1 gap-6 mb-8 md:grid-cols-3">
                    <div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h3 class="mb-2 text-lg font-semibold text-theme-primary dark:text-[#eaf1ed]">Total Meeting</h3><p class="text-5xl font-bold text-theme-primary dark:text-theme-accent-light">${meetings.length}</p></div>
                    <div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h3 class="mb-2 text-lg font-semibold text-theme-primary dark:text-[#eaf1ed]">Item Tindakan Terbuka</h3><p class="text-5xl font-bold text-yellow-500">${pendingActionItems.length}</p></div>
                    <div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h3 class="mb-2 text-lg font-semibold text-theme-primary dark:text-[#eaf1ed]">Item Tindakan Lewat Batas</h3><p class="text-5xl font-bold text-theme-danger">${overdueActionItems.length}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-1 p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg">
                        <h3 class="mb-4 text-xl font-bold text-theme-primary dark:text-theme-accent-light">Status Item Tindakan</h3>
                        <div class="relative h-80">
                            <canvas id="statusPieChart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg">
                        <h3 class="mb-4 text-xl font-bold text-theme-primary dark:text-theme-accent-light">Item Tindakan per Klinik</h3>
                        <div class="relative h-80">
                            <canvas id="itemsPerClinicChart"></canvas>
                        </div>
                    </div>
                </div>
                <section>
                    <h3 class="mb-4 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Item Tindakan Lewat Batas Waktu</h3>
                    ${overdueActionItems.length > 0 ? `<div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">${overdueActionItems.map(item => `
                                <div class="p-4 bg-red-100 dark:bg-red-900/50 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl hover:-translate-y-1 transform">
                                    <h4 class="mb-1 text-xl font-semibold text-red-800 dark:text-red-200">${item.title}</h4>
                                    <p class="text-sm text-red-700 dark:text-red-300">Ditugaskan ke: <span class="font-medium">${item.assignedTo}</span></p>
                                    <p class="text-sm text-red-700 dark:text-red-300">Batas Waktu: <span class="font-medium">${formatShortDisplayDate(item.dueDate)}</span></p>
                                    <button data-action="navigate" data-page="meeting-detail" data-id="${item.meetingId}" class="px-4 py-2 mt-4 text-sm text-white bg-theme-danger rounded-md hover:bg-theme-danger-dark transition-transform duration-200 hover:scale-105">Lihat Meeting</button>
                                </div>`).join('')}</div>` : `<p class="text-gray-600 dark:text-gray-400">Tidak ada item tindakan yang melewati batas waktu.</p>`}
                </section>`;

            const pieCtx = document.getElementById('statusPieChart').getContext('2d');
            AppState.chartInstances.pieChart = new Chart(pieCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#b39058', '#32629d', '#10B981'], borderColor: document.documentElement.classList.contains('dark') ? '#1a2b42' : '#fefdfc', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, ...getChartThemeOptions() } });
            const barCtx = document.getElementById('itemsPerClinicChart').getContext('2d');
            AppState.chartInstances.barChart = new Chart(barCtx, { type: 'bar', data: { labels: Object.keys(itemsPerClinic), datasets: [{ label: 'Jumlah Item', data: Object.values(itemsPerClinic), backgroundColor: '#32629d', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, ...getChartThemeOptions() } });
        }
        
        function renderMeetingList() {
            appRoot.querySelector('main').innerHTML = `
                <div class="p-6 fade-in">
                    <h2 class="mb-6 text-4xl font-extrabold text-theme-primary dark:text-theme-accent-light">Daftar Meeting</h2>
                    <div class="p-4 mb-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="search-term" placeholder="Cari berdasarkan judul..." class="md:col-span-2 px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" />
                            <select id="filter-clinic" class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent">
                                <option value="Semua">Semua Klinik</option>
                                ${AppState.clinics.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            <button data-action="navigate" data-page="new-meeting" class="w-full px-6 py-2 text-white bg-theme-accent rounded-lg shadow-md hover:bg-theme-accent-dark transition-all duration-300 transform hover:scale-105">+ Meeting Baru</button>
                            <div class="md:col-span-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400">Filter Tanggal:</label>
                                <div class="flex items-center space-x-2">
                                    <input type="date" id="start-date" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" />
                                    <span>-</span>
                                    <input type="date" id="end-date" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="meeting-list-container" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
                </div>`;

            const container = document.getElementById('meeting-list-container');
            const searchInput = document.getElementById('search-term');
            const filterSelect = document.getElementById('filter-clinic');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            let allMeetings = [];

            const applyFilters = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filterClinic = filterSelect.value;
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                if(endDate) endDate.setHours(23,59,59,999);
                const filtered = allMeetings.filter(meeting => {
                    const meetingDate = new Date(meeting.date);
                    const matchesDate = (!startDate || meetingDate >= startDate) && (!endDate || meetingDate <= endDate);
                    const matchesClinic = filterClinic === 'Semua' || (meeting.participants && meeting.participants.includes(filterClinic));
                    const matchesSearch = searchTerm === '' || meeting.title.toLowerCase().includes(searchTerm);
                    return matchesDate && matchesClinic && matchesSearch;
                });
                container.innerHTML = filtered.length > 0 ? filtered.map(MeetingCard).join('') : `<p class="col-span-full p-4 text-center text-gray-600 dark:text-gray-400">Tidak ada meeting yang ditemukan.</p>`;
            };

            [searchInput, filterSelect, startDateInput, endDateInput].forEach(el => el.addEventListener('input', applyFilters));
            
            const q = query(collection(AppState.db, `${AppState.getSharedDataPath()}/meetings`));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const meetingsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                meetingsData.sort((a, b) => new Date(b.date) - new Date(a.date));
                allMeetings = meetingsData;
                applyFilters();
            });
            AppState.listeners.push(unsubscribe);
        }

        async function renderSearchResults() {
             const searchTerm = AppState.currentSearchTerm;
             appRoot.querySelector('main').innerHTML = `<div class="p-6 fade-in"><h2 class="mb-6 text-3xl font-extrabold text-theme-primary dark:text-theme-accent-light">Hasil Pencarian untuk: "<span class="text-theme-accent dark:text-theme-accent-light">${searchTerm}</span>"</h2><div id="search-results-content">${LoadingSpinner()}</div></div>`;
             const content = document.getElementById('search-results-content');
             if (!searchTerm) { content.innerHTML = `<p class="text-gray-600 dark:text-gray-400">Silakan masukkan kata kunci untuk memulai pencarian.</p>`; return; }

             const meetingsQuery = getDocs(query(collection(AppState.db, `${AppState.getSharedDataPath()}/meetings`)));
             const itemsQuery = getDocs(query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`)));

             const [meetingsSnapshot, itemsSnapshot] = await Promise.all([meetingsQuery, itemsQuery]);
             const lowerCaseSearchTerm = searchTerm.toLowerCase();
             const foundMeetings = meetingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(m => m.title && m.title.toLowerCase().includes(lowerCaseSearchTerm));
             const foundItems = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(i => i.title && i.title.toLowerCase().includes(lowerCaseSearchTerm));
             if (foundMeetings.length === 0 && foundItems.length === 0) { content.innerHTML = `<p class="text-gray-600 dark:text-gray-400">Tidak ada hasil yang ditemukan.</p>`; return; }

             content.innerHTML = `
                ${foundMeetings.length > 0 ? `<section class="mb-8"><h3 class="mb-4 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Meeting Ditemukan (${foundMeetings.length})</h3><div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">${foundMeetings.map(MeetingCard).join('')}</div></section>` : ''}
                ${foundItems.length > 0 ? `<section><h3 class="mb-4 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Item Tindakan Ditemukan (${foundItems.length})</h3><ul class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">${foundItems.map(item => ActionItemListItem(item, false)).join('')}</ul></section>` : ''}
             `;
        }

        function renderMeetingDetail() {
            appRoot.querySelector('main').innerHTML = LoadingSpinner();
            if (!AppState.db || !AppState.currentMeetingId) return;

            const meetingId = AppState.currentMeetingId;
            const meetingRef = doc(AppState.db, `${AppState.getSharedDataPath()}/meetings`, meetingId);
            
            const unsubMeeting = onSnapshot(meetingRef, (docSnap) => {
                if (!docSnap.exists()) { appRoot.querySelector('main').innerHTML = ErrorDisplay("Meeting tidak ditemukan."); return; }
                const meeting = { id: docSnap.id, ...docSnap.data() };
                
                // FIX: Fetch all items and filter client-side to avoid indexing issues
                const actionItemsQuery = query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`));
                const unsubItems = onSnapshot(actionItemsQuery, (snapshot) => {
                    const actionItems = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(item => item.meetingId === meetingId);

                    const groupedActionItems = actionItems.reduce((acc, item) => { const clinicName = item.assignedTo || 'Tidak Ditugaskan'; if (!acc[clinicName]) acc[clinicName] = []; acc[clinicName].push(item); return acc; }, {});
                    
                    appRoot.querySelector('main').innerHTML = `
                        <div class="p-6 fade-in"><div class="flex items-center justify-between mb-6"><h2 class="text-4xl font-extrabold text-theme-primary dark:text-theme-accent-light">${meeting.title}</h2><div class="space-x-3"><button data-action="navigate" data-page="edit-meeting" data-id="${meeting.id}" class="px-5 py-2 text-white bg-green-500 rounded-lg hover:bg-green-600 transition-transform duration-200 hover:scale-105 shadow-md">Edit Meeting</button><button data-action="delete-meeting" data-id="${meeting.id}" class="px-5 py-2 text-white bg-theme-danger rounded-lg hover:bg-theme-danger-dark transition-transform duration-200 hover:scale-105 shadow-md">Hapus Meeting</button></div></div><div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><p class="mb-4 text-gray-700 dark:text-gray-300"><span class="font-semibold text-theme-primary dark:text-[#eaf1ed]">Tanggal:</span> ${formatDisplayDate(meeting.date,{year:"numeric",month:"long",day:"numeric"})}</p><p class="mb-6 text-gray-700 dark:text-gray-300"><span class="font-semibold text-theme-primary dark:text-[#eaf1ed]">Peserta:</span> ${meeting.participants?.join(", ")}</p><div class="mb-8"><h3 class="mb-3 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Diskusi Umum</h3><div class="p-4 bg-theme-background dark:bg-gray-700 rounded-lg whitespace-pre-wrap">${meeting.discussionPoints.split("\n").map(l=>l.trim()?`<p>${l}</p>`:"").join("")}</div></div><div class="mb-8"><h3 class="mb-3 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Pembaruan dari Klinik</h3>${meeting.clinicUpdates&&0<Object.keys(meeting.clinicUpdates).length?`<div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">${Object.entries(meeting.clinicUpdates).map(([c,u])=>`<div class="p-4 bg-theme-background dark:bg-gray-700 rounded-lg"><span class="font-semibold text-theme-primary dark:text-[#eaf1ed]">${c}:</span><ul class="ml-4 list-disc list-inside">${u.split("\n").map(l=>l.trim()?`<li>${l.trim().replace(/^- /,"")}</li>`:"").join("")}</ul></div>`).join("")}</div>`:'<p class="text-gray-600 dark:text-gray-400">Tidak ada pembaruan klinik.</p>'}</div><div><div class="flex items-center justify-between mb-4"><h3 class="text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Item Tindakan</h3><button data-action="add-action-item" class="px-5 py-2 text-white bg-theme-primary hover:bg-theme-primary-dark transition-all duration-300 transform hover:scale-105 rounded-lg shadow-md">+ Item Baru</button></div>${0===actionItems.length?'<p class="text-gray-600 dark:text-gray-400">Tidak ada item tindakan.</p>':`<div class="space-y-6">${Object.entries(groupedActionItems).map(([cN,i])=>`<div class="p-4 border border-theme-accent/30 dark:border-gray-700 rounded-xl"><h4 class="mb-3 text-xl font-semibold text-theme-primary dark:text-[#eaf1ed]">Klinik: ${cN}</h4><ul class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">${i.map(item=>ActionItemListItem(item,!0)).join("")}</ul></div>`).join("")}</div>`}</div></div></div>`;
                });
                AppState.listeners.push(unsubItems);
            });
            AppState.listeners.push(unsubMeeting);
        }
        
        function renderClinicDashboard() {
            appRoot.querySelector('main').innerHTML=`<div class="p-6 fade-in"><h2 class="mb-6 text-4xl font-extrabold text-theme-primary dark:text-theme-accent-light">Dashboard Klinik</h2><div class="mb-8"><label for="clinic-select" class="block mb-2 text-lg font-medium text-theme-primary dark:text-gray-300">Pilih Klinik:</label><select id="clinic-select" class="w-full max-w-sm px-4 py-2 bg-theme-card dark:bg-theme-card-dark border-2 border-transparent dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-theme-accent">${AppState.clinics.map(c=>`<option value="${c}">${c}</option>`).join("")}</select></div><div id="clinic-dashboard-content" class="mt-8"></div></div>`;const c=document.getElementById("clinic-dashboard-content"),s=document.getElementById("clinic-select");let uMe,uI;const uD=sC=>{uMe&&uMe(),uI&&uI(),AppState.chartInstances.clinicPieChart&&AppState.chartInstances.clinicPieChart.destroy(),c.innerHTML=LoadingSpinner();const mQ=query(collection(AppState.db,`${AppState.getSharedDataPath()}/meetings`));uMe=onSnapshot(mQ,mS=>{const meetings=mS.docs.map(d=>({id:d.id,...d.data()})).filter(m=>m.participants&&m.participants.includes(sC)).sort((a,b)=>new Date(b.date)-new Date(a.date));const iQ=query(collection(AppState.db,`${AppState.getSharedDataPath()}/actionItems`));uI=onSnapshot(iQ,iS=>{const aI=iS.docs.map(d=>({id:d.id,...d.data()})).filter(i=>i.assignedTo===sC),sCo=aI.reduce((a,i)=>{a[i.status]=(a[i.status]||0)+1;return a},{}),oI=aI.filter(i=>"Done"!==i.status&&i.dueDate&&new Date(i.dueDate)<new Date);c.innerHTML=`<h3 class="mb-6 text-3xl font-bold text-theme-primary dark:text-theme-accent-light">Detail untuk ${sC}</h3><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8"><div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 text-center"><div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h4 class="mb-2 text-lg font-semibold text-theme-primary dark:text-[#eaf1ed]">Total Item</h4><p class="text-5xl font-bold text-theme-primary dark:text-theme-accent-light">${aI.length}</p></div><div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h4 class="mb-2 text-lg font-semibold text-theme-primary dark:text-[#eaf1ed]">Lewat Batas</h4><p class="text-5xl font-bold text-theme-danger">${oI.length}</p></div></div><div class="p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h3 class="mb-4 text-xl font-bold text-theme-primary dark:text-theme-accent-light">Status Item</h3><div class="relative h-64"><canvas id="clinicStatusPieChart"></canvas></div></div></div><section><h4 class="mb-4 text-2xl font-bold text-theme-primary dark:text-theme-accent-light">Item Tindakan untuk ${sC}</h4>${0<aI.length?`<div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">${["Open","In Progress","Done"].map(st=>{const items=aI.filter(i=>i.status===st);return`<div class="p-4 bg-theme-card dark:bg-theme-card-dark/50 rounded-lg shadow-inner"><h5 class="mb-3 text-xl font-semibold text-theme-primary dark:text-[#eaf1ed]">${st} (${items.length})</h5><ul class="space-y-2">${items.map(i=>ActionItemListItem(i)).join("")}</ul></div>`}).join("")}</div>`:`<p class="dark:text-gray-400">Tidak ada item tindakan untuk ${sC}.</p>`}</section>`;if(0<aI.length){const pC=document.getElementById("clinicStatusPieChart").getContext("2d");AppState.chartInstances.clinicPieChart=new Chart(pC,{type:"doughnut",data:{labels:Object.keys(sCo),datasets:[{data:Object.values(sCo),backgroundColor:["#b39058","#32629d","#10B981"],borderColor:document.documentElement.classList.contains("dark")?"#1a2b42":"#fefdfc",borderWidth:4}]},options:{responsive:!0,maintainAspectRatio:!1,...getChartThemeOptions()}})}});AppState.listeners.push(uI)});AppState.listeners.push(uMe)};s.addEventListener("change",e=>uD(e.target.value)),uD(s.value)}
        
        async function renderMeetingForm() {
            const isEditMode = !!AppState.currentMeetingId;
            appRoot.querySelector('main').innerHTML = LoadingSpinner();
            let formState = { date: '', title: '', participants: [], discussionPoints: '- ', clinicUpdates: {}, localActionItems: [], initialActionItems: [] };
            const updateTitle = () => { const titleEl = document.getElementById('auto-title'); if (formState.date) { const d = new Date(formState.date); if (!isNaN(d.getTime())) formState.title = `Meeting ${d.toLocaleDateString('id-ID',{year:'numeric',month:'long',day:'numeric'})}`; } else formState.title = ''; if(titleEl) titleEl.textContent = formState.title || 'Pilih tanggal'; };
            const renderLocalActionItems = () => { const fs = window.currentMeetingFormState; if (!fs) return; AppState.clinics.forEach(c => { const cont = document.getElementById(`action-items-for-${c}`); if (cont) { const items = fs.localActionItems.filter(i => i.assignedTo === c); cont.innerHTML = items.length > 0 ? `<h4 class="text-sm font-semibold mt-4 mb-2 text-gray-600 dark:text-gray-400">Item:</h4><ul class="space-y-2">${items.map(item => ActionItemListItem(item, true, true)).join('')}</ul>` : ''; }}); };
            
            if (isEditMode) {
                const docRef = doc(AppState.db, `${AppState.getSharedDataPath()}/meetings`, AppState.currentMeetingId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) { 
                    const data = docSnap.data(); 
                    formState = { ...formState, ...data, date: formatShortDisplayDate(data.date) || '' }; 
                    const q = query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`), where("meetingId", "==", AppState.currentMeetingId)); 
                    const items = (await getDocs(q)).docs.map(d => ({ id: d.id, ...d.data() })); 
                    formState.localActionItems = items; 
                    formState.initialActionItems = JSON.parse(JSON.stringify(items)); 
                }
            } else {
                const q = query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`), where('status', '!=', 'Done'));
                const items = (await getDocs(q)).docs.map(d => ({ id: d.id, ...d.data() })); 
                formState.localActionItems = items; 
                formState.initialActionItems = JSON.parse(JSON.stringify(items));
            }
            
            appRoot.querySelector('main').innerHTML = `
                <div class="p-6 fade-in"><h2 class="mb-6 text-4xl font-extrabold text-theme-primary dark:text-theme-accent-light">${isEditMode ? 'Edit Meeting' : 'Meeting Baru'}</h2><form id="meeting-form" class="p-8 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-2xl">
                    <div class="mb-6"><label for="date" class="block mb-2 text-sm font-medium text-theme-primary dark:text-[#eaf1ed]">Tanggal</label><input type="date" id="date" value="${formState.date}" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" required /></div>
                    <div class="mb-6"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-[#eaf1ed]">Judul</label><p id="auto-title" class="w-full px-4 py-2 bg-theme-background dark:bg-gray-700 border dark:border-gray-600 rounded-lg min-h-[42px]"></p></div>
                    <div class="mb-6"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-[#eaf1ed]">Peserta</label><div class="p-4 bg-theme-background dark:bg-gray-700/50 rounded-lg grid grid-cols-2 gap-2 md:grid-cols-3"><div class="flex items-center"><input type="checkbox" id="participant-all" class="w-4 h-4 text-theme-primary rounded focus:ring-theme-accent" /><label for="participant-all" class="ml-2 dark:text-gray-200">Semua</label></div>${AppState.clinics.map(c => `<div class="flex items-center"><input type="checkbox" id="p-${c}" data-clinic="${c}" class="w-4 h-4 text-theme-primary rounded focus:ring-theme-accent participant-checkbox" ${formState.participants.includes(c) ? 'checked' : ''} /><label for="p-${c}" class="ml-2 dark:text-gray-200">${c}</label></div>`).join('')}</div></div>
                    <div class="mb-6"><label for="discussionPoints" class="block mb-2 text-sm font-medium text-theme-primary dark:text-[#eaf1ed]">Diskusi Umum</label><textarea id="discussionPoints" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" placeholder="...">${formState.discussionPoints}</textarea></div>
                    <div class="mb-6"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-[#eaf1ed]">Pembaruan Klinik</label><div class="space-y-4">${AppState.clinics.map(clinic => `<div class="p-4 border border-theme-accent/30 dark:border-gray-700 rounded-xl"><label for="update-${clinic}" class="mb-2 text-lg font-semibold text-theme-primary dark:text-theme-accent-light">${clinic}:</label><div class="flex items-center space-x-2"><textarea id="update-${clinic}" data-clinic="${clinic}" class="clinic-update-textarea flex-grow px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" placeholder="...">${formState.clinicUpdates[clinic] || '- '}</textarea><button type="button" data-action="add-local-action-item" data-clinic="${clinic}" class="px-3 py-2 text-sm text-white bg-theme-primary rounded-lg hover:bg-theme-primary-dark transition-transform duration-200 hover:scale-105" title="+ Item">+ Item</button></div><div id="action-items-for-${clinic}" class="mt-3"></div></div>`).join('')}</div></div>
                    <div class="flex justify-end space-x-4 mt-8"><button type="button" data-action="navigate" data-page="${isEditMode ? 'meeting-detail' : 'meetings'}" data-id="${AppState.currentMeetingId || ''}" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-transform duration-200 hover:scale-105">Batal</button><button type="submit" class="px-6 py-2 text-white bg-theme-accent rounded-lg shadow-md hover:bg-theme-accent-dark transition-all duration-300 transform hover:scale-105">${isEditMode ? 'Simpan' : 'Buat'}</button></div>
                </form></div>`;
            window.currentMeetingFormState = formState; window.renderLocalActionItems = renderLocalActionItems; updateTitle(); renderLocalActionItems();
            const form = document.getElementById('meeting-form');
            form.addEventListener('submit', (e) => handleMeetingFormSubmit(e, isEditMode));
            document.getElementById('date').addEventListener('change', (e) => { formState.date = e.target.value; updateTitle(); });
            document.getElementById('participant-all').addEventListener('change', (e) => { document.querySelectorAll('.participant-checkbox').forEach(cb => cb.checked = e.target.checked); formState.participants = e.target.checked ? [...AppState.clinics] : []; });
            document.querySelectorAll('.participant-checkbox').forEach(cb => cb.addEventListener('change', (e) => { const c = e.target.dataset.clinic; if (e.target.checked) { if (!formState.participants.includes(c)) formState.participants.push(c); } else { formState.participants = formState.participants.filter(p => p !== c); }}));
            
            // Auto-resize textareas
            const textareas = document.querySelectorAll('#discussionPoints, .clinic-update-textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', () => autoResizeTextarea(textarea));
                setTimeout(() => autoResizeTextarea(textarea), 0); // Initial resize for existing content
            });
        }

        // --- AUTHENTICATION & INITIALIZATION ---

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(AppState.auth, provider); } 
            catch (error) { console.error("Error signing in:", error); const errEl = document.getElementById('auth-error'); if(errEl) errEl.textContent = "Gagal login. Silakan coba lagi."; }
        }

        async function signOutUser() {
            try { await signOut(AppState.auth); } 
            catch (error) { console.error("Error signing out:", error); alert("Gagal logout."); }
        }

        appRoot.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]'); if (!target) return;
            const action = target.dataset.action, id = target.dataset.id, page = target.dataset.page, clinic = target.dataset.clinic;
            switch (action) {
                case 'navigate': navigateTo(page, id); break;
                case 'login-google': await signInWithGoogle(); break;
                case 'logout': await signOutUser(); break;
                case 'toggle-theme': toggleTheme(); const light = document.getElementById('theme-icon-light'); const dark = document.getElementById('theme-icon-dark'); light.classList.toggle('hidden'); dark.classList.toggle('hidden'); break;
                case 'export-excel': exportAllDataToExcel(); break;
                case 'delete-meeting': showConfirmationModal("Konfirmasi Hapus Meeting", "Anda yakin ingin menghapus meeting ini dan semua item tindakannya?", () => handleDeleteMeeting(id)); break;
                case 'add-action-item': showActionItemFormModal({ meetingId: AppState.currentMeetingId }); break;
                case 'edit-action-item': { const item = await getDoc(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, id)); if (item.exists()) showActionItemFormModal({ selectedActionItem: {id, ...item.data()}, meetingId: AppState.currentMeetingId }); } break;
                case 'delete-action-item': showConfirmationModal("Konfirmasi Hapus Item", "Anda yakin ingin menghapus item tindakan ini?", () => handleDeleteActionItem(id)); break;
                case 'add-local-action-item': showActionItemFormModal({ onSaveLocally: handleSaveLocallyActionItem, clinicToAssignAction: clinic }); break;
                case 'edit-local-action-item': { const item = window.currentMeetingFormState.localActionItems.find(i => String(i.id) === id); if(item) showActionItemFormModal({ onSaveLocally: handleSaveLocallyActionItem, selectedActionItem: item }); } break;
                case 'delete-local-action-item': showConfirmationModal("Konfirmasi Hapus Item", "Anda yakin ingin menghapus item ini?", () => { window.currentMeetingFormState.localActionItems = window.currentMeetingFormState.localActionItems.filter(i => String(i.id) !== id); window.renderLocalActionItems(); }); break;
            }
        });

        appRoot.addEventListener('submit', (e) => { if (e.target.id === 'global-search-form') { e.preventDefault(); const searchInput = document.getElementById('global-search-input'); const searchTerm = searchInput.value.trim(); if (searchTerm) navigateTo('search-results', searchTerm); }});

        async function handleMeetingFormSubmit(e, isEditMode) {
            e.preventDefault();
            const formState = window.currentMeetingFormState;
            const discussionPoints = document.getElementById('discussionPoints').value;
            const clinicUpdates = {};
            document.querySelectorAll('.clinic-update-textarea').forEach(ta => { clinicUpdates[ta.dataset.clinic] = ta.value; });
            const participants = [];
            document.querySelectorAll('.participant-checkbox:checked').forEach(cb => { participants.push(cb.dataset.clinic); });
            const meetingData = { title: formState.title, date: formState.date || null, participants, discussionPoints, clinicUpdates, updatedAt: serverTimestamp() };
            try {
                if (isEditMode) {
                    const meetingId = AppState.currentMeetingId; const batch = writeBatch(AppState.db); batch.update(doc(AppState.db, `${AppState.getSharedDataPath()}/meetings`, meetingId), meetingData);
                    formState.localActionItems.forEach(item => { const { id, ...data } = item; if (formState.initialActionItems.some(i => i.id === id)) batch.update(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, id), data); else batch.set(doc(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`)), { ...data, meetingId, createdAt: serverTimestamp() }); });
                    formState.initialActionItems.filter(i => !formState.localActionItems.some(l => l.id === i.id)).forEach(item => batch.delete(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, item.id)));
                    await batch.commit(); navigateTo('meeting-detail', meetingId);
                } else {
                    const docRef = await addDoc(collection(AppState.db, `${AppState.getSharedDataPath()}/meetings`), { ...meetingData, createdAt: serverTimestamp() });
                    const newMeetingId = docRef.id; const batch = writeBatch(AppState.db);
                    formState.localActionItems.forEach(item => { const { id, ...data } = item; if (item.createdAt) batch.update(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, id), { meetingId: newMeetingId }); else batch.set(doc(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`)), { ...data, meetingId: newMeetingId, createdAt: serverTimestamp() }); });
                    await batch.commit(); navigateTo('meeting-detail', newMeetingId);
                }
            } catch (err) { console.error("Error saving meeting:", err); alert("Gagal menyimpan meeting."); }
        }

        function handleSaveLocallyActionItem(item) { 
            const itemWithStringId = { ...item, id: String(item.id) };
            const state = window.currentMeetingFormState; 
            const index = state.localActionItems.findIndex(i => String(i.id) === String(item.id)); 
            if (index > -1) { state.localActionItems[index] = itemWithStringId; } 
            else { state.localActionItems.push(itemWithStringId); }
            window.renderLocalActionItems(); 
        }

        async function handleDeleteMeeting(meetingId) { try { const batch = writeBatch(AppState.db); const items = await getDocs(query(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`), where("meetingId", "==", meetingId))); items.forEach(doc => batch.delete(doc.ref)); batch.delete(doc(AppState.db, `${AppState.getSharedDataPath()}/meetings`, meetingId)); await batch.commit(); navigateTo('meetings'); } catch (err) { console.error("Error deleting meeting:", err); alert("Gagal menghapus meeting."); } }
        async function handleDeleteActionItem(itemId) { try { await deleteDoc(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, itemId)); } catch (err) { console.error("Error deleting item:", err); alert("Gagal menghapus item."); } }

        function showConfirmationModal(title, message, onConfirm) { const modalId = `modal-${Date.now()}`; modalContainer.insertAdjacentHTML('beforeend', `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="w-full max-w-sm p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg"><h3 class="mb-4 text-xl font-semibold text-theme-primary dark:text-white">${title}</h3><p class="mb-6 text-gray-700 dark:text-gray-300">${message}</p><div class="flex justify-end space-x-3"><button data-action="cancel" class="px-4 py-2 text-gray-700 bg-gray-200 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Batal</button><button data-action="confirm" class="px-4 py-2 text-white bg-theme-danger rounded-lg hover:bg-theme-danger-dark">Konfirmasi</button></div></div></div>`); const modalElement = document.getElementById(modalId); modalElement.addEventListener('click', (e) => { if (e.target.dataset.action === 'confirm') onConfirm(); if (e.target.dataset.action) modalElement.remove(); }); }
        
        function showActionItemFormModal({ onSaveLocally, meetingId, selectedActionItem, clinicToAssignAction }) {
            const modalId = `modal-form-${Date.now()}`;
            const isEditMode = !!selectedActionItem;
            let itemState = { id: isEditMode ? selectedActionItem.id : Date.now().toString(), title: isEditMode ? selectedActionItem.title || '' : '', assignedTo: isEditMode ? selectedActionItem.assignedTo || '' : clinicToAssignAction || '', dueDate: isEditMode ? formatShortDisplayDate(selectedActionItem.dueDate) : '', status: isEditMode ? selectedActionItem.status || 'Open' : 'Open', followUps: isEditMode ? JSON.parse(JSON.stringify(selectedActionItem.followUps || [])) : [] };
            
            const renderFollowUps = () => {
                const container = document.getElementById(`${modalId}-followups`);
                if (container) {
                    container.innerHTML = itemState.followUps.map((fu, i) => `
                        <li class="flex items-start justify-between p-3 bg-theme-background dark:bg-gray-700 rounded-md">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Tanggal: ${formatShortDisplayDate(fu.followUpDate)}</p>
                                <p class="text-sm text-gray-700 dark:text-gray-300">${fu.followUpDetail}</p>
                            </div>
                            <button type="button" data-action="remove-followup" data-index="${i}" class="ml-4 text-red-500 hover:text-red-700" title="Hapus Follow-up">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </li>`).join('');
                }
            };
            
            modalContainer.insertAdjacentHTML('beforeend', `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4"><div class="w-full max-w-lg p-6 bg-theme-card dark:bg-theme-card-dark rounded-xl shadow-lg flex flex-col max-h-[90vh]"><h3 class="mb-6 text-2xl font-semibold text-theme-primary dark:text-white flex-shrink-0">${isEditMode ? 'Edit Item Tindakan' : 'Item Tindakan Baru'}</h3><form id="${modalId}-form" class="flex flex-col flex-grow min-h-0"><div class="flex-grow overflow-y-auto pr-4 -mr-4"><div class="mb-4"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-gray-300">Judul</label><input type="text" name="title" value="${itemState.title}" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" required /></div><div class="mb-4"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-gray-300">Ditugaskan</label><select name="assignedTo" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" required><option value="">Pilih</option>${AppState.clinics.map(c => `<option value="${c}" ${itemState.assignedTo === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="mb-4"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-gray-300">Batas Waktu</label><input type="date" name="dueDate" value="${itemState.dueDate}" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" /></div><div class="mb-6"><label class="block mb-2 text-sm font-medium text-theme-primary dark:text-gray-300">Status</label><select name="status" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent">${['Open', 'In Progress', 'Done'].map(s => `<option value="${s}" ${itemState.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="pt-4 mt-4 mb-6 border-t border-gray-200 dark:border-gray-700"><h4 class="mb-3 text-lg font-semibold text-theme-primary dark:text-white">Follow-up</h4><ul id="${modalId}-followups" class="mb-4 space-y-2"></ul><div class="flex flex-col space-y-2"><input type="date" id="${modalId}-fu-date" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" /><textarea id="${modalId}-fu-detail" rows="2" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-accent" placeholder="..."></textarea><button type="button" data-action="add-followup" class="px-4 py-2 text-sm text-white bg-green-600 rounded-md hover:bg-green-700">Tambah</button></div></div></div><div class="flex justify-end pt-4 mt-auto space-x-3 border-t border-gray-200 dark:border-gray-700 flex-shrink-0"><button type="button" data-action="cancel" class="px-4 py-2 text-gray-700 bg-gray-200 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Batal</button><button type="button" data-action="confirm-action-item" class="px-4 py-2 text-white bg-theme-primary rounded-lg hover:bg-theme-primary-dark">${isEditMode ? 'Simpan' : 'Tambah'}</button></div></form></div></div>`);
            
            renderFollowUps(); 
            const modalEl = document.getElementById(modalId);
            
            modalEl.addEventListener('click', async (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const action = target.dataset.action;

                if (action === 'cancel') {
                    modalEl.remove();
                } else if (action === 'add-followup') {
                    const d = document.getElementById(`${modalId}-fu-date`), t = document.getElementById(`${modalId}-fu-detail`);
                    if (d.value && t.value) {
                        itemState.followUps.push({ followUpDate: d.value, followUpDetail: t.value });
                        d.value = ''; t.value = '';
                        renderFollowUps();
                    }
                } else if (action === 'remove-followup') {
                    itemState.followUps.splice(e.target.dataset.index, 1);
                    renderFollowUps();
                } else if (action === 'confirm-action-item') {
                    const formEl = document.getElementById(`${modalId}-form`);
                    const fd = new FormData(formEl);
                    const item = { ...itemState, title: fd.get('title'), assignedTo: fd.get('assignedTo'), dueDate: fd.get('dueDate') || null, status: fd.get('status') };
                    if (onSaveLocally) {
                        onSaveLocally(item);
                    } else if (meetingId) {
                        const { id, ...data } = item;
                        if (isEditMode) {
                            await updateDoc(doc(AppState.db, `${AppState.getSharedDataPath()}/actionItems`, id), { ...data, updatedAt: serverTimestamp() });
                        } else {
                            await addDoc(collection(AppState.db, `${AppState.getSharedDataPath()}/actionItems`), { ...data, meetingId, createdAt: serverTimestamp() });
                        }
                    }
                    modalEl.remove();
                }
            });
        }
        
        async function exportAllDataToExcel() { /* (No changes) */ }
        function navigateTo(page, param = null) { cleanupListeners(); AppState.currentPage = page; if (page === 'meeting-detail' || page === 'edit-meeting') AppState.currentMeetingId = param; if (page === 'search-results') AppState.currentSearchTerm = param; renderAppContent(); }
        function renderAppContent() { const main = appRoot.querySelector('main'); if (!main) return; switch (AppState.currentPage) { case 'dashboard': renderDashboard(); break; case 'meetings': renderMeetingList(); break; case 'meeting-detail': renderMeetingDetail(); break; case 'new-meeting': case 'edit-meeting': renderMeetingForm(); break; case 'clinic-dashboard': renderClinicDashboard(); break; case 'search-results': renderSearchResults(); break; default: renderDashboard(); } }

        async function initializeFirebase() {
            try {
                AppState.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig; 
                if (typeof __firebase_config !== 'undefined' && __firebase_config) { firebaseConfig = JSON.parse(__firebase_config); } 
                else { firebaseConfig = { apiKey: "AIzaSyChAi6kfETyfENB78FAhDFrC_VHDWDRVXs", authDomain: "mymeeting-8c4b4.firebaseapp.com", projectId: "mymeeting-8c4b4", storageBucket: "mymeeting-8c4b4.firebasestorage.app", messagingSenderId: "402496368645", appId: "1:402496368645:web:6c86ab221cee6d1ee4ac6c" }; }
                const app = initializeApp(firebaseConfig); AppState.db = getFirestore(app); AppState.auth = getAuth(app);
                onAuthStateChanged(AppState.auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        const userDocRef = doc(AppState.db, "authorizedUsers", user.email);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            AppState.userId = user.uid; AppState.loading = false;
                            appRoot.innerHTML = `<header id="app-header"></header><main id="app-main"></main>`;
                            appRoot.querySelector('#app-header').innerHTML = Header(); renderAppContent();
                        } else {
                            const email = user.email; signOut(AppState.auth).then(() => { appRoot.innerHTML = LoginPage(`Akses ditolak. Email ${email} tidak terdaftar.`); });
                        }
                    } else {
                        cleanupListeners(); AppState.userId = null; AppState.loading = false; appRoot.innerHTML = LoginPage();
                    }
                });
            } catch (err) { console.error("Firebase Init Error:", err); AppState.error = "Gagal inisialisasi Firebase."; AppState.loading = false; appRoot.innerHTML = ErrorDisplay(AppState.error); }
        }

        appRoot.innerHTML = LoadingSpinner();
        initializeFirebase();

    </script>
</body>
</html>

